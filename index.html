<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libs de Monitoração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração do Tailwind para usar a fonte Inter e cores personalizadas
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#05132A', // Azul Índigo para ações principais
                        'secundary-blue': '#05132A', // Verde Esmeralda para ações secundárias
                        'card-bg': '#FFFFFF', // Fundo do cartão branco
                        'body-bg': '#F3F4F6', // Fundo do body cinza claro
                        'text-dark': '#1F2937', // Texto principal escuro
                        'text-light': '#6B7280', // Texto secundário
                        'input-bg': '#FFFFFF', // Fundo do input
                        'input-border': '#D1D5DB', // Borda do input
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos globais para um visual mais agradável */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFFFF;
        }
        /* Estilo para animações e transições */
        .transition-all {
            transition-property: all;
            transition-duration: 300ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Estilos personalizados para os tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #4B5563;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Posição acima do elemento */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 200px;
            font-size: 0.8rem;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #4B5563 transparent transparent transparent;
        }
        /* Animação de loading do botão */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Cor de fundo para o campo desabilitado */
        .disabled-bg {
            background-color: #E5E7EB; /* Cor cinza mais clara */
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen bg-body-bg">

    <!-- Tela de Introdução -->
    <div id="introSection" class="w-full max-w-3xl mx-auto text-center">
        <div class="bg-card-bg p-6 md:p-10 rounded-2xl shadow-2xl space-y-6">
            <h1 class="text-3xl md:text-4xl font-bold text-[#05132A] mb-4">Bem-vindo à Libs de Monitoração</h1>
            <p class="text-lg text-text-dark">
                Esta ferramenta facilita a criação de **monitores para Datadog**, **triggers e alertas para Zabbix**, e **monitores para Dynatrace**, permitindo que você automatize a configuração e a geração de impacto de forma rápida e eficiente.
            </p>
            <button id="startButton"
                    class="w-full sm:w-auto mt-6 bg-primary-blue text-white py-3 px-8 rounded-xl font-semibold shadow-md transition-all duration-300 transform hover:scale-105 hover:bg-indigo-700">
                Iniciar criação do monitor
            </button>
        </div>
    </div>

    <main id="monitorMain" class="w-full max-w-3xl mx-auto hidden">
        <div class="bg-card-bg p-6 md:p-10 rounded-2xl shadow-2xl space-y-6">

            <header class="flex flex-col items-center text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-[#05132A] mb-2">Libs de Monitoração</h1>
                <p class="text-text-light">Automatize a criação de monitores.</p>
            </header>

            <form id="monitorForm" class="space-y-6">

                <div>
                    <label for="monitoringTool" class="block text-sm font-medium text-text-dark mb-1">
                        Ferramenta de monitoração
                        <span class="text-red-500">*</span>
                    </label>
                    <select id="monitoringTool"
                            class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                        <option value="" disabled selected>Selecione a ferramenta de monitoração</option>
                        <option value="Datadog">Datadog</option>
                        <option value="Zabbix">Zabbix</option>
                        <option value="Dynatrace">Dynatrace</option>
                    </select>
                </div>

                <!-- Card "Detalhes do monitor" - agora visível apenas para Datadog/Dynatrace -->
                <div id="monitorDetailsCard" class="hidden space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Detalhes do monitor</h2>
                    <div id="datadogOrgContainer">
                        <label for="datadogOrgSelect" class="block text-sm font-medium text-text-dark mb-1">
                            Org Datadog
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="datadogOrgSelect"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                            <option value="" disabled selected>Selecione a organização</option>
                            <option value="dev">Datadog DEV</option>
                            <option value="uat">Datadog UAT</option>
                            <option value="prd">Datadog PRD</option>
                        </select>
                    </div>

                    <div id="serviceNameContainer">
                        <label for="serviceName" class="block text-sm font-medium text-text-dark mb-1">
                            Nome do Serviço
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="serviceName" placeholder="Ex: auth-api"
                               class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                    </div>

                    <div id="technologyContainer">
                        <label for="technologySelect" class="block text-sm font-medium text-text-dark mb-1">
                            Tecnologia
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="technologySelect"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                            <option value="" disabled selected>Selecione a tecnologia</option>
                        </select>
                    </div>
                </div>

                <div id="zabbixFields" class="hidden space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Detalhes do Trigger</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="triggerName" class="block text-sm font-medium text-text-dark mb-1">
                                Nome do Alerta
                                <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="triggerName"
                                placeholder="Ex: CPU Alta no Servidor Principal"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"
                            />
                        </div>

                        <div>
                            <label for="hostGroup" class="block text-sm font-medium text-text-dark mb-1">
                                Grupo de Hosts
                                <span class="text-red-500">*</span>
                            </label>
                            <select
                                id="hostGroup"
                                disabled
                                class="w-full disabled-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark cursor-not-allowed"
                            >
                                <option value="" disabled selected>Carregando grupos de hosts...</option>
                            </select>
                        </div>

                        <div>
                            <label for="condition" class="block text-sm font-medium text-text-dark mb-1">
                                Condição de Acionamento (Expressão Zabbix)
                                <span class="text-red-500">*</span>
                            </label>
                            <select
                                id="condition"
                                disabled
                                class="w-full disabled-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark cursor-not-allowed"
                            >
                                <option value="" disabled selected>Carregando condições de acionamento...</option>
                            </select>
                        </div>
                        <div>
                            <label for="actionEmail" class="block text-sm font-medium text-text-dark mb-1">
                                E-mail para Notificação
                            </label>
                            <input
                                type="email"
                                id="actionEmail"
                                placeholder="Ex: seu-email@dominio.com"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"
                            />
                        </div>
                    </div>
                </div>

                <div class="space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Geração de Impacto</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="journey" class="block text-sm font-medium text-text-dark mb-1">
                                Jornada
                            </label>
                            <input type="text" id="journey" placeholder="Ex: Conta Corrente; Investimentos"
                                   class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-secundary-blue focus:border-secundary-blue transition-all duration-200 text-text-dark">
                        </div>

                        <div>
                            <label for="product" class="block text-sm font-medium text-text-dark mb-1">
                                Produto
                            </label>
                            <input type="text" id="product" placeholder="Ex: Extrato; Pix"
                                   class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-secundary-blue focus:border-secundary-blue transition-all duration-200 text-text-dark">
                        </div>

                        <div class="flex flex-col space-y-2">
                            <button type="button" id="impactButton" disabled
                                    class="w-full flex items-center justify-center bg-gray-400 text-white py-3 px-6 rounded-xl font-semibold shadow-md transition-all duration-300 transform hover:scale-105 cursor-not-allowed">
                                Gerar sugestão de Impacto
                                <span class="inline-block ml-2 tooltip cursor-help">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                    <span class="tooltip-text">Essa opção só é habilitada quando os campos Jornada e Produto são preenchidos.</span>
                                </span>
                            </button>
                            <div id="impactError" class="hidden text-red-600 text-sm text-center"></div>
                        </div>
                    </div>
                </div>

                <div id="impactSection">
                    <label for="businessImpact" class="block text-sm font-medium text-text-dark mb-1">
                        Impacto ao negócio
                    </label>
                    <textarea id="businessImpact" rows="3" placeholder="Descreva o impacto ao negócio na visão do usuário."
                               class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"></textarea>
                </div>

                <button type="button" id="createMonitorBtn" disabled
                        class="w-full flex items-center justify-center bg-gray-400 text-white py-3 px-6 rounded-xl font-semibold shadow-md transition-all duration-300 transform hover:scale-105 cursor-not-allowed">
                    Criar Monitor
                    <span class="inline-block ml-2 tooltip cursor-help">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        <span class="tooltip-text">Essa ação só pode ser executada após o preenchimento da ferramenta de monitoração, nome do serviço e tecnologia.</span>
                    </span>
                </button>

                <div id="apiErrorContainer" class="mt-4 hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
                    <strong class="font-bold">Erro!</strong>
                    <span id="apiErrorMessage" class="block sm:inline"></span>
                </div>

            </form>

            <div id="resultSection" class="mt-6 hidden">
                <div id="congratulations" class="text-center mb-4 p-6 bg-green-100/70 rounded-xl shadow-inner border border-green-200">
                    <h2 class="text-2xl font-extrabold text-green-800 mb-2">Parabéns! 🎉</h2>
                    <p id="monitorDetails" class="text-text-dark">O seu monitor foi criado com sucesso!</p>
                </div>

                <!-- Seção para links de Golden Signals -->
                <!-- Título da seção alterado para ser mais genérico -->
                <div id="goldenSignalsContainer" class="mt-4 hidden bg-gray-50 p-6 rounded-xl space-y-3 w-full">
                    <h3 class="text-lg font-bold text-text-dark">Links dos monitores:</h3>
                </div>

                <div class="pt-4 flex justify-center">
                    <button type="button" id="newMonitorBtn"
                            class="bg-primary-blue text-white font-semibold py-3 px-6 rounded-xl shadow-md transition-all duration-300 hover:bg-indigo-700">
                        Criar novo monitor
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Obtenção dos elementos do DOM
        const startButton = document.getElementById('startButton');
        const introSection = document.getElementById('introSection');
        const monitorMain = document.getElementById('monitorMain');

        const monitorForm = document.getElementById('monitorForm');
        const serviceNameContainer = document.getElementById('serviceNameContainer');
        const serviceNameInput = document.getElementById('serviceName');
        const monitoringToolSelect = document.getElementById('monitoringTool');
        const datadogOrgContainer = document.getElementById('datadogOrgContainer');
        const datadogOrgSelect = document.getElementById('datadogOrgSelect');
        const technologyContainer = document.getElementById('technologyContainer');
        const technologySelect = document.getElementById('technologySelect');
        const journeyInput = document.getElementById('journey');
        const productInput = document.getElementById('product');
        const impactButton = document.getElementById('impactButton');
        const businessImpactTextarea = document.getElementById('businessImpact');
        const impactErrorDiv = document.getElementById('impactError');
        const createMonitorBtn = document.getElementById('createMonitorBtn');
        const resultSection = document.getElementById('resultSection');
        const apiErrorContainer = document.getElementById('apiErrorContainer');
        const apiErrorMessage = document.getElementById('apiErrorMessage');
        const congratulationsSection = document.getElementById('congratulations');
        const monitorDetailsParagraph = document.getElementById('monitorDetails');
        const goldenSignalsContainer = document.getElementById('goldenSignalsContainer');
        const newMonitorBtn = document.getElementById('newMonitorBtn');

        // Novos campos específicos para Zabbix
        const zabbixFieldsContainer = document.getElementById('zabbixFields');
        const triggerNameInput = document.getElementById('triggerName');
        const hostGroupSelect = document.getElementById('hostGroup');
        const conditionSelect = document.getElementById('condition');
        const actionEmailInput = document.getElementById('actionEmail');
        
        // Mapeamento das tecnologias por ferramenta de monitoração
        const technologiesByTool = {
            'Datadog': ['Kubernetes', 'Express.js', 'AWS', 'Docker', 'Python', 'Flask', 'Java', 'Spring Boot', 'Node.js', 'Go', 'PHP', 'Ruby'],
            'Zabbix': ['Linux', 'Windows', 'MySQL', 'PostgreSQL', 'Nginx', 'Apache', 'VMware'],
            'Dynatrace': ['AWS', 'Azure', 'Kubernetes', 'Java', 'Spring Boot', 'C#', 'Go', 'PHP', 'Websphere', 'Express.js'],
        };
        let currentTechnologies = [];
        const originalImpactBtnText = "Gerar sugestão de Impacto";
        const loadingImpactBtnText = "Gerando...";
        const originalCreateBtnText = "Criar Monitor";
        const loadingCreateBtnText = "Criando...";

        // Mapeamento das métricas Golden Signals por tecnologia
        const goldenSignalsByTechnology = {
            'Kubernetes': [
                { signal: 'Latência', metric: 'kube.service.latency.p99', description: 'Latência de requisições' },
                { signal: 'Tráfego', metric: 'kube.service.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'kube.service.errors', description: 'Taxa de erros' },
                { signal: 'Saturação', metric: 'kube.pod.cpu.saturation', description: 'Saturação da CPU do Pod' }
            ],
            'Python': [
                { signal: 'Latência', metric: 'python.flask.request.latency', description: 'Latência da aplicação' },
                { signal: 'Tráfego', metric: 'python.request.count', description: 'Contagem de requisições HTTP' },
                { signal: 'Erros', metric: 'python.request.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'python.process.cpu_usage', description: 'Uso de CPU do processo' }
            ],
            'Flask': [
                { signal: 'Latência', metric: 'flask.request.latency', description: 'Latência das requisições' },
                { signal: 'Tráfego', metric: 'flask.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'flask.request.errors', description: 'Taxa de erros do Flask' },
                { signal: 'Saturação', metric: 'flask.process.cpu_usage', description: 'Uso de CPU do processo' }
            ],
            'Java': [
                { signal: 'Latência', metric: 'java.http.server.request.latency', description: 'Latência das requisições' },
                { signal: 'Tráfego', metric: 'java.http.server.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'java.http.server.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'java.jvm.memory.usage', description: 'Uso de memória JVM' }
            ],
            'Spring Boot': [
                { signal: 'Latência', metric: 'spring.http.server.requests.latency', description: 'Latência das requisições do Spring Boot' },
                { signal: 'Tráfego', metric: 'spring.http.server.requests.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'spring.http.server.requests.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'spring.jvm.memory.usage', description: 'Uso de memória JVM' }
            ],
            'Node.js': [
                { signal: 'Latência', metric: 'nodejs.http_server.request_time.p99', description: 'Latência de requisições' },
                { signal: 'Tráfego', metric: 'nodejs.http_server.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'nodejs.http_server.errors', description: 'Taxa de erros do servidor' },
                { signal: 'Saturação', metric: 'nodejs.eventloop.lag', description: 'Lag do Event Loop' }
            ],
            'Express.js': [
                { signal: 'Latência', metric: 'express.request.duration', description: 'Latência das requisições do Express.js' },
                { signal: 'Tráfego', metric: 'express.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'express.response.errors', description: 'Taxa de erros no Express.js' },
                { signal: 'Saturação', metric: 'express.cpu.saturation', description: 'Saturação da CPU' }
            ],
            // Métricas genéricas para outras tecnologias
            'default': [
                { signal: 'Latência', metric: 'generic.latency', description: 'Latência do serviço' },
                { signal: 'Tráfego', metric: 'generic.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'generic.errors', description: 'Taxa de erros' },
                { signal: 'Saturação', metric: 'generic.saturation', description: 'Saturação de recursos' }
            ]
        };

        // Dados de grupos de hosts e condições de acionamento do Zabbix (simulados)
        const zabbixHostGroups = [
            'Servidores de Produção',
            'Servidores de Desenvolvimento',
            'Dispositivos de Rede',
            'Bancos de Dados'
        ];
        const zabbixStandardConditions = [
            { label: 'Uso de CPU > 80%', expression: '{hostname:system.cpu.util[,user,avg1].last()} > 80' },
            { label: 'Uso de Memória > 90%', expression: '{hostname:vm.memory.size[pfree].last()} < 10' },
            { label: 'Espaço em Disco > 95%', expression: '{hostname:vfs.fs.size[/,pfree].last()} < 5' },
            { label: 'Serviço HTTP indisponível', expression: '{hostname:web.test.fail[Webpage].last()} = 1' }
        ];
        /**
         * Simula uma chamada de API para buscar grupos de hosts do Zabbix.
         * @returns {Promise<string[]>} Uma promessa que resolve com a lista de grupos.
         */
        function fetchZabbixHostGroups() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(zabbixHostGroups);
                }, 500); // Atraso de 500ms para simular a latência da rede
            });
        }
        /**
         * Simula uma chamada de API para buscar condições de acionamento padrão do Zabbix.
         * @returns {Promise<object[]>} Uma promessa que resolve com a lista de condições.
         */
        function fetchZabbixStandardConditions() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(zabbixStandardConditions);
                }, 500); // Atraso de 500ms para simular a latência da rede
            });
        }

        // Função para preencher o select de tecnologias
        function populateTechnologies(technologies) {
            technologySelect.innerHTML = '<option value="" disabled selected>Selecione a tecnologia</option>';
            technologies.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                technologySelect.appendChild(option);
            });
        }
        
        // Função para habilitar/desabilitar o botão de impacto
        function toggleImpactButton(isFilled) {
            impactButton.disabled = !isFilled;
            if (isFilled) {
                impactButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                impactButton.classList.add('bg-primary-blue', 'hover:bg-indigo-600');
            } else {
                impactButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                impactButton.classList.remove('bg-primary-blue', 'hover:bg-indigo-600');
            }
        }
        
        // Função para validar se os campos de impacto estão preenchidos
        function validateImpactFields() {
            const isFilled = journeyInput.value.trim() !== '' && productInput.value.trim() !== '';
            toggleImpactButton(isFilled);
        }

        // Função para habilitar/desabilitar o botão de criação
        function toggleCreateMonitorButton(isFilled) {
            createMonitorBtn.disabled = !isFilled;
            if (isFilled) {
                createMonitorBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                createMonitorBtn.classList.add('bg-primary-blue', 'hover:bg-indigo-700');
            } else {
                createMonitorBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                createMonitorBtn.classList.remove('bg-primary-blue', 'hover:bg-indigo-700');
            }
        }
        
        // **NOVA FUNÇÃO** para habilitar/desabilitar todos os campos do formulário
        function toggleFormFields(isDisabled) {
            monitoringToolSelect.disabled = isDisabled;
            serviceNameInput.disabled = isDisabled;
            technologySelect.disabled = isDisabled;
            datadogOrgSelect.disabled = isDisabled;
            journeyInput.disabled = isDisabled;
            productInput.disabled = isDisabled;
            businessImpactTextarea.disabled = isDisabled;
            impactButton.disabled = isDisabled;
            createMonitorBtn.disabled = isDisabled;
            // Campos específicos do Zabbix
            triggerNameInput.disabled = isDisabled;
            hostGroupSelect.disabled = isDisabled;
            conditionSelect.disabled = isDisabled;
            actionEmailInput.disabled = isDisabled;

            // Ajusta o estilo dos campos desabilitados
            const fields = [
                monitoringToolSelect, serviceNameInput, technologySelect, datadogOrgSelect,
                journeyInput, productInput, businessImpactTextarea, impactButton, createMonitorBtn,
                triggerNameInput, hostGroupSelect, conditionSelect, actionEmailInput
            ];

            fields.forEach(field => {
                if (isDisabled) {
                    field.classList.add('disabled-bg', 'cursor-not-allowed');
                } else {
                    field.classList.remove('disabled-bg', 'cursor-not-allowed');
                }
            });
            // Revalida os botões depois de habilitar os campos
            if (!isDisabled) {
                validateImpactFields();
                validateMonitorCreation();
            }
        }

        // Função para validar a criação do monitor com base na ferramenta selecionada
        function validateMonitorCreation() {
            const selectedTool = monitoringToolSelect.value;
            let isFormValid = false;

            if (selectedTool === 'Datadog' || selectedTool === 'Dynatrace') {
                isFormValid = monitoringToolSelect.value !== '' &&
                                serviceNameInput.value.trim() !== '' &&
                                technologySelect.value !== '' &&
                                datadogOrgSelect.value !== '';
            } else if (selectedTool === 'Zabbix') {
                isFormValid = monitoringToolSelect.value !== '' &&
                                triggerNameInput.value.trim() !== '' &&
                                hostGroupSelect.value !== '' &&
                                conditionSelect.value !== '';
            } else {
                isFormValid = false;
            }

            toggleCreateMonitorButton(isFormValid);
        }
        
        /**
         * Gera links de exemplo para o monitor criado.
         * @param {string} tool - A ferramenta de monitoramento.
         * @returns {object[]} Um array de objetos com o nome e o URL do link.
         */
        function generateMonitorLinks(tool, monitorName) {
            const linkBaseUrl = "https://example.com";
            switch (tool) {
                case 'Datadog':
                    const technology = technologySelect.value;
                    const goldenSignals = goldenSignalsByTechnology[technology] || goldenSignalsByTechnology['default'];
                    return goldenSignals.map(signal => ({
                        name: `Monitor ${signal.signal}: ${signal.metric}`,
                        url: `https://app.datadoghq.com/monitors#create/metric?q=avg:${signal.metric}{service:${monitorName}}`
                    }));
                case 'Zabbix':
                    return [
                        { name: `Trigger: ${monitorName}`, url: `${linkBaseUrl}/zabbix/triggers` },
                        { name: 'Dashboard de Alertas', url: `${linkBaseUrl}/zabbix/alerts` }
                    ];
                case 'Dynatrace':
                    return [
                        { name: `Monitor: ${monitorName}`, url: `${linkBaseUrl}/dynatrace/monitors` },
                        { name: 'Serviços Dynatrace', url: `${linkBaseUrl}/dynatrace/services` }
                    ];
                default:
                    return [];
            }
        }


        // Função para criar o monitor (agora com lógica de exibição)
        async function createMonitor() {
            // Desabilita o formulário inteiro
            toggleFormFields(true);
            createMonitorBtn.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg> ${loadingCreateBtnText}`;

            await new Promise(resolve => setTimeout(resolve, 1500)); // Simula o tempo de API
            
            // Reverte o estado do botão antes de ocultar o formulário.
            createMonitorBtn.innerHTML = `${originalCreateBtnText}
                <span class="inline-block ml-2 tooltip cursor-help">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                    <span class="tooltip-text">Essa ação só pode ser executada após o preenchimento da ferramenta de monitoração, nome do serviço e tecnologia.</span>
                </span>`;

            const selectedTool = monitoringToolSelect.value;
            const serviceName = serviceNameInput.value.trim();
            const triggerName = triggerNameInput.value.trim();

            monitorDetailsParagraph.innerHTML = `O seu monitor foi criado com sucesso!`;
            
            goldenSignalsContainer.innerHTML = '<h3 class="text-lg font-bold text-text-dark">Link do monitor:</h3>';
            
            let links = [];
            let monitorName = '';
            if (selectedTool === 'Datadog' || selectedTool === 'Dynatrace') {
                monitorName = serviceName;
                links = generateMonitorLinks(selectedTool, monitorName);
            } else if (selectedTool === 'Zabbix') {
                monitorName = triggerName;
                links = generateMonitorLinks(selectedTool, monitorName);
            }
            
            // Adiciona os links gerados ao container
            links.forEach(link => {
                const signalLink = document.createElement('a');
                signalLink.href = link.url;
                signalLink.target = "_blank";
                signalLink.className = "block bg-white hover:bg-gray-100 p-3 rounded-lg border border-gray-200 transition-all text-text-dark font-semibold";
                signalLink.textContent = link.name;
                goldenSignalsContainer.appendChild(signalLink);
            });
            
            if (links.length > 0) {
                goldenSignalsContainer.classList.remove('hidden');
            } else {
                goldenSignalsContainer.classList.add('hidden');
            }

            monitorForm.classList.add('hidden');
            resultSection.classList.remove('hidden');

            console.log("Monitor criado com sucesso. O formulário foi ocultado e a seção de resultados foi exibida.");
        }

        // Função para gerar a sugestão de impacto
        async function generateImpactSuggestion() {
            // Desabilita o botão e mostra o estado de loading
            impactButton.disabled = true;
            impactButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg> ${loadingImpactBtnText}`;
            impactErrorDiv.classList.add('hidden');

            const journey = journeyInput.value;
            const product = productInput.value;
            const prompt = `Gere uma descrição de impacto ao negócio de no máximo 150 caracteres, baseado na jornada "${journey}" e no produto "${product}".`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    businessImpactTextarea.value = text;
                } else {
                    impactErrorDiv.textContent = 'Não foi possível gerar a sugestão. Tente novamente.';
                    impactErrorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro ao chamar a API:", error);
                impactErrorDiv.textContent = 'Ocorreu um erro ao gerar a sugestão. Verifique sua conexão ou tente mais tarde.';
                impactErrorDiv.classList.remove('hidden');
            } finally {
                // Restaura o botão
                impactButton.disabled = false;
                impactButton.innerHTML = `${originalImpactBtnText}
                    <span class="inline-block ml-2 tooltip cursor-help">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        <span class="tooltip-text">Essa opção só é habilitada quando os campos Jornada e Produto são preenchidos.</span>
                    </span>`;
            }
        }
        
        // Função para preencher dinamicamente os campos do Zabbix
        async function populateZabbixFields() {
            try {
                // Simula o preenchimento com dados da "API"
                const hostGroups = await fetchZabbixHostGroups();
                hostGroupSelect.innerHTML = '<option value="" disabled selected>Selecione um grupo de hosts</option>';
                hostGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    hostGroupSelect.appendChild(option);
                });
                hostGroupSelect.disabled = false;
                hostGroupSelect.classList.remove('disabled-bg', 'cursor-not-allowed');

                const conditions = await fetchZabbixStandardConditions();
                conditionSelect.innerHTML = '<option value="" disabled selected>Selecione uma condição</option>';
                conditions.forEach(cond => {
                    const option = document.createElement('option');
                    option.value = cond.expression;
                    option.textContent = cond.label;
                    conditionSelect.appendChild(option);
                });
                conditionSelect.disabled = false;
                conditionSelect.classList.remove('disabled-bg', 'cursor-not-allowed');

            } catch (error) {
                console.error("Erro ao buscar dados do Zabbix:", error);
            }
        }
        
        // Função para resetar o formulário
        function resetForm() {
            // Habilita o formulário inteiro
            toggleFormFields(false);
            monitorForm.classList.remove('hidden');
            monitorMain.classList.remove('hidden');
            resultSection.classList.add('hidden');
            apiErrorContainer.classList.add('hidden');
            monitorDetailsCard.classList.add('hidden');
            zabbixFieldsContainer.classList.add('hidden');
            populateTechnologies([]); // Limpa as opções de tecnologia
            validateMonitorCreation();
            validateImpactFields();
        }

        // Adicionando os event listeners
        startButton.addEventListener('click', () => {
            introSection.classList.add('hidden');
            monitorMain.classList.remove('hidden');
        });

        monitoringToolSelect.addEventListener('change', (e) => {
            const selectedTool = e.target.value;
            populateTechnologies(technologiesByTool[selectedTool] || []);
            
            if (selectedTool === 'Datadog' || selectedTool === 'Dynatrace') {
                monitorDetailsCard.classList.remove('hidden');
                zabbixFieldsContainer.classList.add('hidden');
            } else if (selectedTool === 'Zabbix') {
                monitorDetailsCard.classList.add('hidden');
                zabbixFieldsContainer.classList.remove('hidden');
                populateZabbixFields();
            } else {
                monitorDetailsCard.classList.add('hidden');
                zabbixFieldsContainer.classList.add('hidden');
            }
            validateMonitorCreation();
        });
        serviceNameInput.addEventListener('input', validateMonitorCreation);
        technologySelect.addEventListener('change', validateMonitorCreation);
        datadogOrgSelect.addEventListener('change', validateMonitorCreation);
        
        journeyInput.addEventListener('input', validateImpactFields);
        productInput.addEventListener('input', validateImpactFields);
        // Novos listeners para Zabbix
        triggerNameInput.addEventListener('input', validateMonitorCreation);
        hostGroupSelect.addEventListener('change', validateMonitorCreation);
        conditionSelect.addEventListener('change', validateMonitorCreation);


        impactButton.addEventListener('click', generateImpactSuggestion);
        createMonitorBtn.addEventListener('click', createMonitor);
        newMonitorBtn.addEventListener('click', resetForm);

        // Chamada inicial para preencher as tecnologias vazias e validar
        validateMonitorCreation();
        validateImpactFields();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libs de Monitoração</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuração do Tailwind para usar a fonte Inter e cores personalizadas
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#05132A', // Azul Índigo para ações principais
                        'secundary-blue': '#05132A', // Verde Esmeralda para ações secundárias
                        'card-bg': '#FFFFFF', // Fundo do cartão branco
                        'body-bg': '#F3F4F6', // Fundo do body cinza claro
                        'text-dark': '#1F2937', // Texto principal escuro
                        'text-light': '#6B7280', // Texto secundário
                        'input-bg': '#FFFFFF', // Fundo do input
                        'input-border': '#D1D5DB', // Borda do input
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos globais para um visual mais agradável */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFFFFF;
        }
        /* Estilo para animações e transições */
        .transition-all {
            transition-property: all;
            transition-duration: 300ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Estilos personalizados para os tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            background-color: #4B5563;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%; /* Posição acima do elemento */
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 200px;
            font-size: 0.8rem;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #4B5563 transparent transparent transparent;
        }
        /* Animação de loading do botão */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* Cor de fundo para o campo desabilitado */
        .disabled-bg {
            background-color: #E5E7EB; /* Cor cinza mais clara */
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen bg-body-bg">

    <!-- Tela de Introdução -->
    <div id="introSection" class="w-full max-w-3xl mx-auto text-center">
        <div class="bg-card-bg p-6 md:p-10 rounded-2xl shadow-2xl space-y-6">
            <h1 class="text-3xl md:text-4xl font-bold text-[#05132A] mb-4">Bem-vindo à Libs de Monitoração</h1>
            <p class="text-lg text-text-dark">
                Esta ferramenta permite que você crie de forma rápida e prática monitores para Datadog e Dynatrace, além de triggers e alertas para Zabbix, tudo de maneira automática.
            </p>
            <button id="startButton"
                    class="w-full sm:w-auto mt-6 bg-primary-blue text-white py-3 px-8 rounded-xl font-semibold shadow-md transition-colors hover:bg-[#1A2D4A]">
                Iniciar criação do monitor
            </button>
        </div>
    </div>

    <main id="monitorMain" class="w-full max-w-3xl mx-auto hidden">
        <div class="bg-card-bg p-6 md:p-10 rounded-2xl shadow-2xl space-y-6">

            <header class="flex flex-col items-center text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-[#05132A] mb-2">Libs de Monitoração</h1>
                <p class="text-text-light">Automatize a criação de monitores.</p>
            </header>

            <form id="monitorForm" class="space-y-6">

                <div>
                    <label for="monitoringTool" class="block text-sm font-medium text-text-dark mb-1">
                        Ferramenta de monitoração
                        <span class="text-red-500">*</span>
                    </label>
                    <select id="monitoringTool"
                            class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                        <option value="" disabled selected>Selecione a ferramenta de monitoração</option>
                        <option value="Datadog">Datadog</option>
                        <option value="Zabbix">Zabbix</option>
                        <option value="Dynatrace">Dynatrace</option>
                    </select>
                </div>

                <!-- Card "Detalhes do monitor" - agora visível apenas para Datadog/Dynatrace -->
                <div id="monitorDetailsCard" class="hidden space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Detalhes do monitor</h2>
                    <div id="datadogOrgContainer">
                        <label for="datadogOrgSelect" class="block text-sm font-medium text-text-dark mb-1">
                            Org Datadog
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="datadogOrgSelect"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                            <option value="" disabled selected>Selecione a organização</option>
                            <option value="dev">Datadog DEV</option>
                            <option value="uat">Datadog UAT</option>
                            <option value="prd">Datadog PRD</option>
                        </select>
                    </div>

                    <div id="serviceNameContainer">
                        <label for="serviceName" class="block text-sm font-medium text-text-dark mb-1">
                            Nome do Serviço
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="serviceName" placeholder="Ex: auth-api"
                               class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                    </div>

                    <div id="technologyContainer">
                        <label for="technologySelect" class="block text-sm font-medium text-text-dark mb-1">
                            Tecnologia
                            <span class="text-red-500">*</span>
                        </label>
                        <select id="technologySelect"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark">
                            <option value="" disabled selected>Selecione a tecnologia...</option>
                        </select>
                    </div>
                </div>

                <div id="zabbixFields" class="hidden space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Detalhes do Trigger</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="triggerName" class="block text-sm font-medium text-text-dark mb-1">
                                Nome do Alerta
                                <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="triggerName"
                                placeholder="Ex: CPU Alta no Servidor Principal"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"
                            />
                        </div>

                        <div>
                            <label for="hostGroup" class="block text-sm font-medium text-text-dark mb-1">
                                Grupo de Hosts
                                <span class="text-red-500">*</span>
                            </label>
                            <select
                                id="hostGroup"
                                disabled
                                class="w-full disabled-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark cursor-not-allowed"
                            >
                                <option value="" disabled selected>Carregando grupos de hosts...</option>
                            </select>
                        </div>

                        <div>
                            <label for="condition" class="block text-sm font-medium text-text-dark mb-1">
                                Condição de Acionamento (Expressão Zabbix)
                                <span class="text-red-500">*</span>
                            </label>
                            <select
                                id="condition"
                                disabled
                                class="w-full disabled-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark cursor-not-allowed"
                            >
                                <option value="" disabled selected>Carregando condições de acionamento...</option>
                            </select>
                        </div>
                        <div>
                            <label for="zabbixServiceName" class="block text-sm font-medium text-text-dark mb-1">
                                Nome do Serviço
                                <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="zabbixServiceName"
                                placeholder="Ex: API de Autenticação"
                                class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"
                            />
                        </div>
                    </div>
                </div>

                <div class="space-y-6 p-4 bg-gray-50 rounded-xl">
                    <h2 class="text-lg font-bold text-text-dark">Geração de Impacto</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="journey" class="block text-sm font-medium text-text-dark mb-1">
                                Jornada
                            </label>
                            <input type="text" id="journey" placeholder="Ex: Conta Corrente; Investimentos"
                                   class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-secundary-blue focus:border-secundary-blue transition-all duration-200 text-text-dark">
                        </div>

                        <div>
                            <label for="product" class="block text-sm font-medium text-text-dark mb-1">
                                Produto
                            </label>
                            <input type="text" id="product" placeholder="Ex: Extrato; Pix"
                                   class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-secundary-blue focus:border-secundary-blue transition-all duration-200 text-text-dark">
                        </div>

                        <div class="flex flex-col space-y-2">
                            <button type="button" id="impactButton" disabled
                                    class="w-full flex items-center justify-center bg-gray-400 text-white py-3 px-6 rounded-xl font-semibold shadow-md transition-colors cursor-not-allowed">
                                Gerar sugestão de Impacto
                                <span class="inline-block ml-2 tooltip cursor-help">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                    <span class="tooltip-text">Essa opção só é habilitada quando os campos Jornada e Produto são preenchidos.</span>
                                </span>
                            </button>
                            <div id="impactError" class="hidden text-red-600 text-sm text-center"></div>
                        </div>
                    </div>
                </div>

                <div id="impactSection">
                    <label for="businessImpact" class="block text-sm font-medium text-text-dark mb-1">
                        Impacto ao negócio
                    </label>
                    <textarea id="businessImpact" rows="3" placeholder="Descreva o impacto ao negócio na visão do usuário."
                               class="w-full bg-input-bg border border-input-border rounded-xl px-4 py-3 focus:ring-primary-blue focus:border-primary-blue transition-all duration-200 text-text-dark"></textarea>
                </div>

                <button type="button" id="createMonitorBtn" disabled
                        class="w-full flex items-center justify-center bg-gray-400 text-white py-3 px-6 rounded-xl font-semibold shadow-md transition-colors cursor-not-allowed">
                    Criar Monitor
                    <span class="inline-block ml-2 tooltip cursor-help">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        <span class="tooltip-text">Essa ação só pode ser executada após o preenchimento da ferramenta de monitoração, nome do serviço e tecnologia.</span>
                    </span>
                </button>

                <div id="apiErrorContainer" class="mt-4 hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
                    <strong class="font-bold">Erro!</strong>
                    <span id="apiErrorMessage" class="block sm:inline"></span>
                </div>

            </form>

            <div id="resultSection" class="mt-6 hidden">
                <div id="congratulations" class="text-center mb-4 p-6 bg-green-100/70 rounded-xl shadow-inner border border-green-200">
                    <h2 class="text-2xl font-extrabold text-green-800 mb-2">Parabéns! 🎉</h2>
                    <p id="monitorDetails" class="text-text-dark">O seu monitor foi criado com sucesso!</p>
                </div>

                <!-- Seção para links de Golden Signals -->
                <!-- Título da seção alterado para ser mais genérico -->
                <div id="goldenSignalsContainer" class="mt-4 hidden bg-gray-50 p-6 rounded-xl space-y-3 w-full">
                    <h3 class="text-lg font-bold text-text-dark">Links dos monitores:</h3>
                </div>

                <div class="pt-4 flex justify-center">
                    <button type="button" id="newMonitorBtn"
                            class="bg-primary-blue text-white font-semibold py-3 px-6 rounded-xl shadow-md transition-colors hover:bg-[#1A2D4A]">
                        Criar novo monitor
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Obtenção dos elementos do DOM
        const startButton = document.getElementById('startButton');
        const introSection = document.getElementById('introSection');
        const monitorMain = document.getElementById('monitorMain');

        const monitorForm = document.getElementById('monitorForm');
        const serviceNameContainer = document.getElementById('serviceNameContainer');
        const serviceNameInput = document.getElementById('serviceName');
        const monitoringToolSelect = document.getElementById('monitoringTool');
        const datadogOrgContainer = document.getElementById('datadogOrgContainer');
        const datadogOrgSelect = document.getElementById('datadogOrgSelect');
        const technologyContainer = document.getElementById('technologyContainer');
        const technologySelect = document.getElementById('technologySelect');
        const journeyInput = document.getElementById('journey');
        const productInput = document.getElementById('product');
        const impactButton = document.getElementById('impactButton');
        const businessImpactTextarea = document.getElementById('businessImpact');
        const impactErrorDiv = document.getElementById('impactError');
        const createMonitorBtn = document.getElementById('createMonitorBtn');
        const resultSection = document.getElementById('resultSection');
        const apiErrorContainer = document.getElementById('apiErrorContainer');
        const apiErrorMessage = document.getElementById('apiErrorMessage');
        const congratulationsSection = document.getElementById('congratulations');
        const monitorDetailsParagraph = document.getElementById('monitorDetails');
        const goldenSignalsContainer = document.getElementById('goldenSignalsContainer');
        const newMonitorBtn = document.getElementById('newMonitorBtn');

        // Novos campos específicos para Zabbix
        const zabbixFieldsContainer = document.getElementById('zabbixFields');
        const triggerNameInput = document.getElementById('triggerName');
        const hostGroupSelect = document.getElementById('hostGroup');
        const conditionSelect = document.getElementById('condition');
        const zabbixServiceNameInput = document.getElementById('zabbixServiceName');
        const monitorDetailsCard = document.getElementById('monitorDetailsCard');
        
        // Mapeamento das tecnologias por ferramenta de monitoração
        const technologiesByTool = {
            'Datadog': ['Kubernetes', 'Express.js', 'AWS', 'Docker', 'Python', 'Flask', 'Java', 'Spring Boot', 'Node.js', 'Go', 'PHP', 'Ruby'],
            'Zabbix': ['Linux', 'Windows', 'MySQL', 'PostgreSQL', 'Nginx', 'Apache', 'VMware'],
            'Dynatrace': ['AWS', 'Azure', 'Kubernetes', 'Java', 'Spring Boot', 'C#', 'Go', 'PHP', 'Websphere', 'Express.js'],
        };
        let currentTechnologies = [];
        const originalImpactBtnText = "Gerar sugestão de Impacto";
        const loadingImpactBtnText = "Gerando...";
        const originalCreateBtnText = "Criar Monitor";
        const loadingCreateBtnText = "Criando...";

        // Mapeamento das métricas Golden Signals por tecnologia
        const goldenSignalsByTechnology = {
            'Kubernetes': [
                { signal: 'Latência', metric: 'kube.service.latency.p99', description: 'Latência de requisições' },
                { signal: 'Tráfego', metric: 'kube.service.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'kube.service.errors', description: 'Taxa de erros' },
                { signal: 'Saturação', metric: 'kube.pod.cpu.saturation', description: 'Saturação da CPU do Pod' }
            ],
            'Python': [
                { signal: 'Latência', metric: 'python.flask.request.latency', description: 'Latência da aplicação' },
                { signal: 'Tráfego', metric: 'python.request.count', description: 'Contagem de requisições HTTP' },
                { signal: 'Erros', metric: 'python.request.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'python.process.cpu_usage', description: 'Uso de CPU do processo' }
            ],
            'Flask': [
                { signal: 'Latência', metric: 'flask.request.latency', description: 'Latência das requisições' },
                { signal: 'Tráfego', metric: 'flask.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'flask.request.errors', description: 'Taxa de erros do Flask' },
                { signal: 'Saturação', metric: 'flask.process.cpu_usage', description: 'Uso de CPU do processo' }
            ],
            'Java': [
                { signal: 'Latência', metric: 'java.http.server.request.latency', description: 'Latência das requisições' },
                { signal: 'Tráfego', metric: 'java.http.server.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'java.http.server.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'java.jvm.memory.usage', description: 'Uso de memória JVM' }
            ],
            'Spring Boot': [
                { signal: 'Latência', metric: 'spring.http.server.requests.latency', description: 'Latência das requisições do Spring Boot' },
                { signal: 'Tráfego', metric: 'spring.http.server.requests.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'spring.http.server.requests.errors', description: 'Taxa de erros HTTP' },
                { signal: 'Saturação', metric: 'spring.jvm.memory.usage', description: 'Uso de memória JVM' }
            ],
            'Node.js': [
                { signal: 'Latência', metric: 'nodejs.http_server.request_time.p99', description: 'Latência de requisições' },
                { signal: 'Tráfego', metric: 'nodejs.http_server.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'nodejs.http_server.errors', description: 'Taxa de erros do servidor' },
                { signal: 'Saturação', metric: 'nodejs.eventloop.lag', description: 'Lag do Event Loop' }
            ],
            'Express.js': [
                { signal: 'Latência', metric: 'express.request.duration', description: 'Latência das requisições do Express.js' },
                { signal: 'Tráfego', metric: 'express.request.count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'express.response.errors', description: 'Taxa de erros no Express.js' },
                { signal: 'Saturação', metric: 'express.cpu.saturation', description: 'Saturação da CPU' }
            ],
            // Métricas genéricas para outras tecnologias
            'default': [
                { signal: 'Latência', metric: 'generic.latency', description: 'Latência do serviço' },
                { signal: 'Tráfego', metric: 'generic.request_count', description: 'Contagem de requisições' },
                { signal: 'Erros', metric: 'generic.errors', description: 'Taxa de erros' },
                { signal: 'Saturação', metric: 'generic.saturation', description: 'Saturação de recursos' }
            ]
        };

        // Dados de grupos de hosts e condições de acionamento do Zabbix (simulados)
        const zabbixHostGroups = [
            'Servidores de Produção',
            'Servidores de Desenvolvimento',
            'Dispositivos de Rede',
            'Bancos de Dados'
        ];
        const zabbixStandardConditions = [
            { label: 'Uso de CPU > 80%', expression: '{hostname:system.cpu.util[,user,avg1].last()} > 80' },
            { label: 'Uso de Memória > 90%', expression: '{hostname:vm.memory.size[pfree].last()} < 10' },
            { label: 'Espaço em Disco > 95%', expression: '{hostname:vfs.fs.size[/,pfree].last()} < 5' },
            { label: 'Serviço HTTP indisponível', expression: '{hostname:web.test.fail[Webpage].last()} = 1' }
        ];

        /**
         * Simula uma chamada de API para buscar grupos de hosts do Zabbix.
         * @returns {Promise<string[]>} Uma promessa que resolve com a lista de grupos.
         */
        function fetchZabbixHostGroups() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(zabbixHostGroups);
                }, 500); // Atraso de 500ms para simular a latência da rede
            });
        }

        /**
         * Simula uma chamada de API para buscar condições de acionamento padrão do Zabbix.
         * @returns {Promise<object[]>} Uma promessa que resolve com a lista de condições.
         */
        function fetchZabbixStandardConditions() {
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(zabbixStandardConditions);
                }, 500); // Atraso de 500ms para simular a latência da rede
            });
        }

        // Função para preencher o select de tecnologias
        function populateTechnologies(technologies) {
            technologySelect.innerHTML = '<option value="" disabled selected>Selecione a tecnologia...</option>';
            technologies.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech;
                option.textContent = tech;
                technologySelect.appendChild(option);
            });
        }

        // Função para preencher os campos do Zabbix
        async function populateZabbixFields() {
            // Desabilita os campos enquanto carrega
            hostGroupSelect.disabled = true;
            conditionSelect.disabled = true;
            hostGroupSelect.classList.add('disabled-bg', 'cursor-not-allowed');
            conditionSelect.classList.add('disabled-bg', 'cursor-not-allowed');

            try {
                // Simula o carregamento dos dados
                const groups = await fetchZabbixHostGroups();
                const conditions = await fetchZabbixStandardConditions();

                // Preenche o select de grupos de hosts
                hostGroupSelect.innerHTML = '<option value="" disabled selected>Selecione o grupo de hosts...</option>';
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    hostGroupSelect.appendChild(option);
                });

                // Preenche o select de condições
                conditionSelect.innerHTML = '<option value="" disabled selected>Selecione a condição...</option>';
                conditions.forEach(condition => {
                    const option = document.createElement('option');
                    option.value = condition.expression;
                    option.textContent = condition.label;
                    conditionSelect.appendChild(option);
                });

            } catch (error) {
                console.error("Erro ao carregar dados do Zabbix:", error);
                apiErrorMessage.textContent = 'Erro ao carregar dados do Zabbix. Por favor, tente novamente.';
                apiErrorContainer.classList.remove('hidden');
            } finally {
                // Reabilita os campos após o carregamento
                hostGroupSelect.disabled = false;
                conditionSelect.disabled = false;
                hostGroupSelect.classList.remove('disabled-bg', 'cursor-not-allowed');
                conditionSelect.classList.remove('disabled-bg', 'cursor-not-allowed');
            }
        }


        // Função para validar se os campos de monitoramento estão preenchidos
        function validateMonitorCreation() {
            const selectedTool = monitoringToolSelect.value;
            let isValid = false;

            if (selectedTool === 'Datadog' || selectedTool === 'Dynatrace') {
                isValid = serviceNameInput.value.trim() !== '' && technologySelect.value !== '' && (selectedTool === 'Dynatrace' || datadogOrgSelect.value !== '');
            } else if (selectedTool === 'Zabbix') {
                isValid = triggerNameInput.value.trim() !== '' && hostGroupSelect.value !== '' && conditionSelect.value !== '' && zabbixServiceNameInput.value.trim() !== '';
            }

            if (isValid) {
                createMonitorBtn.disabled = false;
                createMonitorBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                createMonitorBtn.classList.add('bg-primary-blue', 'hover:bg-[#1A2D4A]');
            } else {
                createMonitorBtn.disabled = true;
                createMonitorBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                createMonitorBtn.classList.remove('bg-primary-blue', 'hover:bg-[#1A2D4A]');
            }
        }

        // Função para validar se os campos de impacto estão preenchidos
        function validateImpactFields() {
            const hasImpactFields = journeyInput.value.trim() !== '' && productInput.value.trim() !== '';
            if (hasImpactFields) {
                impactButton.disabled = false;
                impactButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                impactButton.classList.add('bg-secundary-blue', 'hover:bg-[#1A2D4A]');
            } else {
                impactButton.disabled = true;
                impactButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                impactButton.classList.remove('bg-secundary-blue', 'hover:bg-[#1A2D4A]');
            }
        }

        // Função para exibir um modal customizado
        function showCustomModal(message) {
            // Implementação de um modal customizado, não usando alert()
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="p-8 border w-96 shadow-lg rounded-2xl bg-white text-center">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Aviso</h3>
                    <p class="text-gray-600">${message}</p>
                    <div class="mt-6 flex justify-center">
                        <button class="px-6 py-2 text-primary-blue bg-gray-200 rounded-xl font-semibold hover:bg-gray-300">
                            OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }


        // Função para simular a criação de um monitor
        async function createMonitor() {
            createMonitorBtn.disabled = true;
            const originalText = createMonitorBtn.innerHTML;
            createMonitorBtn.innerHTML = `<svg class="animate-spin h-5 w-5 text-white inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                          Criando...`;
            apiErrorContainer.classList.add('hidden');

            try {
                // Simulação de chamada de API com atraso
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Lógica para mostrar a seção de resultado e links dos monitores
                showResultSection();

                // Esconde o formulário
                monitorForm.classList.add('hidden');
                resultSection.classList.remove('hidden');

            } catch (error) {
                console.error("Erro na criação do monitor:", error);
                apiErrorMessage.textContent = 'Erro ao criar o monitor. Por favor, tente novamente.';
                apiErrorContainer.classList.remove('hidden');
            } finally {
                createMonitorBtn.disabled = false;
                createMonitorBtn.innerHTML = originalText;
            }
        }


        // Função para gerar uma sugestão de impacto usando o modelo Gemini
        async function generateImpactSuggestion() {
            const journey = journeyInput.value.trim();
            const product = product.value.trim();
            if (journey === '' || product === '') {
                showCustomModal('Por favor, preencha os campos Jornada e Produto para gerar uma sugestão de impacto.');
                return;
            }

            impactButton.disabled = true;
            const originalText = impactButton.innerHTML;
            impactButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-white inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                      Gerando...`;
            
            try {
                const prompt = `Gere uma descrição de impacto ao negócio de no máximo 50 palavras para os seguintes itens, do ponto de vista do usuário final:
                                Jornada: ${journey}
                                Produto: ${product}
                                Exemplo de resposta: "A instabilidade no sistema pode impedir que o usuário realize transações financeiras, como saques ou transferências, impactando diretamente a sua capacidade de gerenciar suas finanças."`;
                
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = { contents: chatHistory };
                const apiKey = "" 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    businessImpactTextarea.value = text;
                    impactErrorDiv.classList.add('hidden');
                } else {
                    impactErrorDiv.textContent = 'Não foi possível gerar uma sugestão. Tente novamente.';
                    impactErrorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Erro na geração de impacto:", error);
                impactErrorDiv.textContent = 'Não foi possível gerar uma sugestão. Verifique sua conexão e tente novamente.';
                impactErrorDiv.classList.remove('hidden');
            } finally {
                impactButton.disabled = false;
                impactButton.innerHTML = originalText;
            }
        }


        // Função para exibir a seção de resultados e os links
        function showResultSection() {
            const selectedTool = monitoringToolSelect.value;
            const selectedTechnology = technologySelect.value;
            let monitorName = '';
            
            // Limpa o conteúdo anterior
            goldenSignalsContainer.innerHTML = '<h3 class="text-lg font-bold text-text-dark">Links dos monitores:</h3>';
            goldenSignalsContainer.classList.add('hidden');

            // Determina o nome do monitor com base na ferramenta
            if (selectedTool === 'Zabbix') {
                monitorName = zabbixServiceNameInput.value.trim() || triggerNameInput.value;
            } else {
                monitorName = serviceNameInput.value;
            }

            monitorDetailsParagraph.textContent = `O seu monitor "${monitorName}" foi criado com sucesso!`;
            goldenSignalsContainer.classList.remove('hidden');

            if (selectedTool === 'Datadog') {
                const signals = goldenSignalsByTechnology[selectedTechnology] || goldenSignalsByTechnology['default'];
                signals.forEach(signal => {
                    const linkItem = document.createElement('div');
                    linkItem.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center';
                    linkItem.innerHTML = `
                        <div>
                            <p class="font-semibold text-text-dark">${signal.signal}</p>
                            <p class="text-sm text-text-light">${signal.description}</p>
                        </div>
                        <a href="#" class="text-primary-blue hover:underline">Ver monitor</a>
                    `;
                    goldenSignalsContainer.appendChild(linkItem);
                });
            } else if (selectedTool === 'Dynatrace') {
                // Cria um link para o monitor Dynatrace com base no nome do serviço
                const dynatraceBaseUrl = 'https://dynatrace.example.com/ui/apps/dynatrace.classic.problems/ui/problem/details?id=';
                const dynatraceLink = `${dynatraceBaseUrl}${encodeURIComponent(monitorName)}`;

                const linkItem = document.createElement('div');
                linkItem.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center';
                linkItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-text-dark">Dynatrace</p>
                        <p class="text-sm text-text-light">${monitorName}</p>
                    </div>
                    <a href="${dynatraceLink}" target="_blank" class="text-primary-blue hover:underline">Ver monitor</a>
                `;
                goldenSignalsContainer.appendChild(linkItem);
            } else if (selectedTool === 'Zabbix') {
                 // Cria um link para o monitor Zabbix com base no nome do trigger
                const zabbixBaseUrl = 'https://zabbix.example.com/triggers.php?filter_name=';
                const zabbixLink = `${zabbixBaseUrl}${encodeURIComponent(monitorName)}`;

                const linkItem = document.createElement('div');
                linkItem.className = 'bg-white p-4 rounded-xl shadow-md flex justify-between items-center';
                linkItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-text-dark">Zabbix</p>
                        <p class="text-sm text-text-light">${monitorName}</p>
                    </div>
                    <a href="${zabbixLink}" target="_blank" class="text-primary-blue hover:underline">Ver monitor</a>
                `;
                goldenSignalsContainer.appendChild(linkItem);
            }
        }

        // Função para resetar o formulário
        function resetForm() {
            // Limpa os valores dos campos
            monitoringToolSelect.value = '';
            serviceNameInput.value = '';
            datadogOrgSelect.value = '';
            technologySelect.innerHTML = '<option value="" disabled selected>Selecione a tecnologia...</option>';
            journeyInput.value = '';
            productInput.value = '';
            businessImpactTextarea.value = '';
            triggerNameInput.value = '';
            hostGroupSelect.innerHTML = '<option value="" disabled selected>Carregando grupos de hosts...</option>';
            conditionSelect.innerHTML = '<option value="" disabled selected>Carregando condições de acionamento...</option>';
            zabbixServiceNameInput.value = '';

            // Oculta seções e reseta estados
            monitorDetailsCard.classList.add('hidden');
            zabbixFieldsContainer.classList.add('hidden');
            resultSection.classList.add('hidden');
            apiErrorContainer.classList.add('hidden');
            monitorForm.classList.remove('hidden');
            goldenSignalsContainer.classList.add('hidden');
            goldenSignalsContainer.innerHTML = '<h3 class="text-lg font-bold text-text-dark">Links dos monitores:</h3>';


            // Desabilita os botões e reseta os estilos
            impactButton.disabled = true;
            impactButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            impactButton.classList.remove('bg-secundary-blue', 'hover:bg-[#1A2D4A]');
            
            createMonitorBtn.disabled = true;
            createMonitorBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            createMonitorBtn.classList.remove('bg-primary-blue', 'hover:bg-[#1A2D4A]');

            // Garante que o estado inicial seja validado
            validateMonitorCreation();
            validateImpactFields();
        }

        // Event Listeners
        startButton.addEventListener('click', () => {
            introSection.classList.add('hidden');
            monitorMain.classList.remove('hidden');
        });

        monitoringToolSelect.addEventListener('change', () => {
            const selectedTool = monitoringToolSelect.value;
            // Limpa o select de tecnologias antes de preencher
            technologySelect.innerHTML = '<option value="" disabled selected>Selecione a tecnologia...</option>';

            // Lógica para mostrar/esconder campos de acordo com a ferramenta
            if (selectedTool === 'Datadog' || selectedTool === 'Dynatrace') {
                monitorDetailsCard.classList.remove('hidden');
                zabbixFieldsContainer.classList.add('hidden');
                
                // Popula as tecnologias com base na ferramenta selecionada
                const technologies = technologiesByTool[selectedTool] || [];
                populateTechnologies(technologies);

                // Mostra/esconde o seletor de orgs do Datadog
                if (selectedTool === 'Datadog') {
                    datadogOrgContainer.classList.remove('hidden');
                } else {
                    datadogOrgContainer.classList.add('hidden');
                }
            } else if (selectedTool === 'Zabbix') {
                monitorDetailsCard.classList.add('hidden');
                zabbixFieldsContainer.classList.remove('hidden');
                populateZabbixFields();
            } else {
                monitorDetailsCard.classList.add('hidden');
                zabbixFieldsContainer.classList.add('hidden');
            }
            validateMonitorCreation();
        });

        serviceNameInput.addEventListener('input', validateMonitorCreation);
        technologySelect.addEventListener('change', validateMonitorCreation);
        datadogOrgSelect.addEventListener('change', validateMonitorCreation);
        
        journeyInput.addEventListener('input', validateImpactFields);
        productInput.addEventListener('input', validateImpactFields);

        // Novos listeners para Zabbix
        triggerNameInput.addEventListener('input', validateMonitorCreation);
        hostGroupSelect.addEventListener('change', validateMonitorCreation);
        conditionSelect.addEventListener('change', validateMonitorCreation);
        zabbixServiceNameInput.addEventListener('input', validateMonitorCreation);

        impactButton.addEventListener('click', generateImpactSuggestion);
        createMonitorBtn.addEventListener('click', createMonitor);
        newMonitorBtn.addEventListener('click', resetForm);

        // Chamada inicial para preencher as tecnologias vazias e validar
        validateMonitorCreation();
        validateImpactFields();
    </script>
</body>
</html>
